{"version":3,"sources":["CheckoutSkipLogin.ts"],"names":[],"mappings":"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","file":"CheckoutSkipLogin.js","sourcesContent":["/*\n\tÂ© 2020 NetSuite Inc.\n\tUser may not copy, modify, distribute, or re-bundle or otherwise make available this code;\n\tprovided, however, if you are an authorized user with a NetSuite account or log-in, you\n\tmay use this code subject to the terms that govern your access and use.\n*/\n\n/// <amd-module name=\"CheckoutSkipLogin\"/>\n\n/*\n@module CheckoutSkipLogin\nCheckout Skip Login mode. The Checkout Skip Login is a feature that\nis disabled by default and can be enabled by setting property checkoutApp.skipLogin\nto true in backend.configuration.js file.\n\nBasically for implementing skip login what we are doing is\noverriding the ```save()``` method of the following models:\n```LiveOrderModel```, ```AddressModel```, ```CreditCardModel``` and\t```ProfileModel```.\n\nThe objective is to first call register-guest service and only then\ncall the real save() so the operation is made with a guest session.\n*/\nimport * as _ from 'underscore';\nimport * as Utils from '../../../Commons/Utilities/JavaScript/Utils';\nimport * as jQuery from '../../../Commons/Core/JavaScript/jQuery';\nimport { ProfileModel } from '../../../Commons/Profile/JavaScript/Profile.Model';\nimport { AddressModel } from '../../../Commons/Address/JavaScript/Address.Model';\n\nimport AccountRegisterAsGuestModel = require('../../Account/JavaScript/Account.RegisterAsGuest.Model');\nimport LiveOrderModel = require('../../../Commons/LiveOrder/JavaScript/LiveOrder.Model');\nimport PaymentMethodModel = require('../../PaymentMethod/JavaScript/PaymentMethod.Model');\n\nlet promise_guest = null;\n\nexport = {\n    mountToApp: function(application) {\n        const { checkoutApp } = application.getConfig();\n        // do nothing if the mode is disabled\n        if (!checkoutApp.skipLogin) {\n            return;\n        }\n\n        // this function is called only if skip login mode is enabled\n        const registerUserAsGuest = function registerUserAsGuest() {\n            const promise = jQuery.Deferred();\n            const profile_model = ProfileModel.getInstance();\n\n            if (profile_model.get('isGuest') === 'F' && profile_model.get('isLoggedIn') === 'F') {\n                const checkout_step = application.getLayout().currentView.currentStep;\n\n                if (checkout_step) {\n                    checkout_step.disableNavButtons();\n                }\n\n                new AccountRegisterAsGuestModel().save().done(function(data) {\n                    const skip_login_dont_update_profile = profile_model.get(\n                        'skipLoginDontUpdateProfile'\n                    );\n                    const current_view = application.getLayout().currentView;\n\n                    if (skip_login_dont_update_profile && data.user) {\n                        _.each(skip_login_dont_update_profile, function(attr: any) {\n                            delete data.user[attr];\n                        });\n                    }\n\n                    if (data.user) {\n                        profile_model.set(data.user);\n                    }\n\n                    current_view.wizard.options.profile = profile_model;\n\n                    if (data.touchpoints) {\n                        application.setConfig('siteSettings.touchpoints', data.touchpoints);\n                    }\n\n                    promise.resolve();\n\n                    if (checkout_step) {\n                        checkout_step.enableNavButtons();\n                    }\n\n                    current_view.$('[data-action=\"skip-login-message\"]').remove();\n                });\n            } else {\n                promise.resolve();\n            }\n            return promise;\n        };\n\n        // add 'this.application' to models that doesn't have it.\n        AddressModel.prototype.application = application;\n        PaymentMethodModel.prototype.application = application;\n        ProfileModel.prototype.application = application;\n\n        // wrap save() method to LiveOrderModel, AddressModel and CreditCardModel\n        const wrapperCheckoutSkipLogin = function wrapperCheckoutSkipLogin(superFn) {\n            const self = this;\n            const super_arguments = Array.prototype.slice.apply(arguments, [1, arguments.length]);\n            const promise: any = jQuery.Deferred();\n\n            if (!promise_guest) {\n                promise_guest = registerUserAsGuest();\n            }\n\n            let result;\n            promise_guest.done(function() {\n                result = superFn.apply(self, super_arguments);\n\n                if (result) {\n                    result\n                        .done(function() {\n                            promise.resolve.apply(result, arguments);\n                        })\n                        .fail(function() {\n                            promise.reject.apply(result, arguments);\n                        });\n                } else {\n                    // Notify future promises that a front end validation\n                    // took place and no promise is returned\n                    promise.frontEndValidationError = true;\n                    promise.reject.apply(result, super_arguments);\n                }\n            });\n\n            _(promise).extend({\n                error: function() {\n                    return this;\n                },\n                success: function() {\n                    return this;\n                },\n                abort: () => {\n                    promise_guest.done(() => {\n                        if (result) {\n                            result.abort();\n                        }\n                    });\n                }\n            });\n\n            return promise;\n        };\n\n        // Site Builder cart is in Checkout :/ don't wrap if in shopping\n        if (Utils.isInCheckout()) {\n            LiveOrderModel.prototype.save = _.wrap(\n                LiveOrderModel.prototype.save,\n                wrapperCheckoutSkipLogin\n            );\n        }\n\n        AddressModel.prototype.save = _.wrap(AddressModel.prototype.save, wrapperCheckoutSkipLogin);\n\n        PaymentMethodModel.prototype.save = _.wrap(\n            PaymentMethodModel.prototype.save,\n            wrapperCheckoutSkipLogin\n        );\n\n        ProfileModel.prototype.save = _.wrap(ProfileModel.prototype.save, wrapperCheckoutSkipLogin);\n    }\n};\n"]}